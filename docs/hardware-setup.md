# Hardware Setup

## Overview

This document outlines the hardware setup required for LuxNix, including disk encryption, boot configuration, and hardware-specific settings.

## Prerequisites

Before beginning setup, ensure you have:

- ### A computer with UEFI boot support

#### Check if your system is booted in UEFI mode
[ -d /sys/firmware/efi ] && echo "UEFI" || echo "BIOS"

#### For more details
ls /sys/firmware/efi/efivars

- ### At least one storage device (NVMe or SATA)
- ### (Optional) USB stick for boot decryption
- ### (Optional) FIDO2 security key for enhanced security

## Storage Configuration

### Disk Layout
The standard disk layout for LuxNix requires:
1. EFI System Partition (ESP)
   - Size: 512MB minimum
   - Format: FAT32
   - Mount point: `/boot`

2. Root Partition
   - Size: Remaining space
   - Format: LUKS2 encrypted ext4
   - Mount point: Various (see below)

### Mount Points
The system uses an [impermanence setup](security.md#luks-encryption-management) with the following mount points:
- `/` (root)
- `/home`
- `/nix`
- `/nix/store`
- `/persist`
- `/var/log`

## Hardware-Specific Configuration

### Required Files
1. `hardware-configuration.nix`
   - Generated automatically by NixOS
   - Contains hardware-specific settings
   - Located in your system's configuration directory

2. `disks.nix`
   - Defines disk partitioning and mount points
   - Uses [disko](https://github.com/nix-community/disko) for configuration

3. `sensitive-hdd.nix`
   - Contains encrypted drive configurations
   - Should be kept private and not committed to version control

4. `boot-decryption-config.nix`
   - Generated by the boot-decryption-stick setup
   - Contains USB decryption configuration

### Example Configuration

Basic hardware configuration structure:
```nix
{
  config,
  lib,
  pkgs,
  modulesPath,
  ...
}: {
  imports = [
    (modulesPath + "/installer/scan/not-detected.nix")
  ];

  boot.initrd.availableKernelModules = [
    "nvme"
    "xhci_pci"
    "ahci"
    "usbhid"
    "usb_storage"
    "sd_mod"
  ];

  # Add your specific hardware modules here
  boot.kernelModules = [ "kvm-intel" ];  # For Intel CPUs
}
```

## Boot Decryption Setup

The boot decryption setup involves:

1. Creating a USB decryption stick:
   ```bash
   sudo boot-decryption-stick-setup
   ```

2. Importing the configuration:
   ```nix
   {
     imports = [
       ./hardware-configuration.nix
       ./disks.nix
       ./boot-decryption-config.nix
     ];
   }
   ```

See [Boot Decryption Documentation](security.md#boot-decryption-usb-stick-setup) for detailed setup instructions.

## Hardware Detection

LuxNix uses various methods for hardware detection:

1. NixOS Hardware Modules:
   ```nix
   # In flake.nix
   inputs.nixos-hardware.url = "github:nixos/nixos-hardware";
   ```

2. Automatic hardware detection during installation

3. Manual configuration when needed

## Required Information

To complete hardware setup, you'll need:

1. Storage Device Information:
   - Device paths (e.g., `/dev/nvme0n1`)
   - Partition layout
   - LUKS encryption details ([see security guide](security.md#luks-encryption-management))

2. Hardware Specifics:
   - CPU type (Intel/AMD)
   - GPU details
   - Special hardware features

3. Boot Requirements:
   - UEFI/Legacy boot
   - Secure Boot status
   - TPM availability

## Next Steps

After hardware setup:
1. Complete [security configuration](security.md)
2. Set up user environment
3. Configure system services

## Troubleshooting

Common issues and solutions:
1. Boot failures: Check boot decryption stick configuration
2. Hardware detection issues: Update hardware-configuration.nix
3. Disk mounting problems: Verify disks.nix configuration
