- name: Deploy keycloak role password from source
  ansible.builtin.copy:
    src: "{{ lx_vault_dir_src }}/deploy/{{ inventory_hostname }}/{{ keycloak_host_password_filename }}"
    dest: "{{ lx_vault_dir }}/{{ keycloak_host_password_filename }}"
    mode: "0660"
    owner: "{{ ansible_user }}"
    group: "keycloak"
  become: true
  become_user: root
  no_log: false
  vars:
    ansible_vault_identity: "{{ inventory_hostname }}@{{ lx_vault_dir_src }}/psk/{{ inventory_hostname }}.psk"

- name: Read keycloak database password from file
  ansible.builtin.command: "cat {{ lx_vault_dir }}/{{ keycloak_host_password_filename }}"
  register: keycloak_db_password
  become: true
  become_user: root
  changed_when: false
  no_log: false

- name: Set PostgreSQL password for keycloak user
  community.postgresql.postgresql_user:
    name: keycloak
    password: "{{ keycloak_db_password.stdout }}"
    state: present
  become: true
  become_user: postgres
  no_log: false
