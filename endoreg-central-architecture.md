# EndoReg Database Architecture Configuration

This document describes the configuration for the EndoReg database system with central and local nodes.

## Architecture Overview

- **Central Node (s-04)**: Runs the main database API service that aggregates data from local nodes
- **Local Nodes**: Run local database API services that connect to their own PostgreSQL instances and communicate with the central node

## Configuration

### Central Node Configuration (s-04)

The central node uses the `endoreg-db-central-01` role:

```yaml
# ansible/inventory/group_vars/endoreg_db_central_01.yml
group_roles:
  endoreg_db_central_01.enable: "true"
  endoreg_db_central_01.centralNodes: ["s-04"]
  endoreg_db_central_01.localNodes: ["gs-01", "gs-02", "gc-05", "gc-06", "gc-10"]
  endoreg_db_central_01.api.hostname: "0.0.0.0"  # Listen on all interfaces
  endoreg_db_central_01.api.port: 8118
  endoreg_db_central_01.api.djangoAllowedHosts: ["s-04", "s-04.local", "172.16.255.14"]
```

### Local Node Configuration

Local nodes use the `endoreg-client` role with `centralNodes` specified:

```yaml
# ansible/inventory/group_vars/endoreg_db_api_local.yml
group_roles:
  endoreg_client.enable: "true"
  endoreg_client.dbApiLocal: "true"
  endoreg_client.centralNodes: ["s-04"]  # Points to central node
```

## Key Features

### Central Node Features
1. **Extended ALLOWED_HOSTS**: Automatically includes all local node hostnames
2. **Higher Resource Limits**: More workers, memory, and timeout settings
3. **Production Settings**: DEBUG=False, secure SSL settings
4. **Nginx Reverse Proxy**: Automatic HTTPS termination (when enabled)
5. **Central Database**: Uses `endoregDbCentral` database

### Local Node Features
1. **Central Node Awareness**: Knows about central nodes via `CENTRAL_NODES` setting
2. **Local Database**: Uses `endoregDbLocal` database
3. **Resource Optimized**: Lighter resource usage for local operations

## Ansible Inventory Groups

```ini
[endoreg_db_central_01]
s-04

[endoreg_db_api_local]
gs-01
gs-02
gc-05
gc-06
gc-10
```

## Django Configuration

The system automatically generates different Django settings for central vs local nodes:

### Central Node Settings
- `IS_CENTRAL_NODE = True`
- `CENTRAL_NODES = ["s-04"]`
- `LOCAL_NODES = ["gs-01", "gs-02", "gc-05", "gc-06", "gc-10"]`
- Extended `ALLOWED_HOSTS` includes all local nodes

### Local Node Settings
- `IS_CENTRAL_NODE = False`
- `CENTRAL_NODES = ["s-04"]`
- Standard `ALLOWED_HOSTS` for local access

## Network Configuration

- **Central Node**: Opens firewall port 8118 for incoming connections from local nodes
- **Local Nodes**: Connect outbound to central node on port 8118

## Security Considerations

1. Central node uses separate secret key file: `/etc/secrets/vault/django_central_secret_key`
2. Central node enforces HTTPS in production
3. Database passwords are managed separately for central vs local databases
4. SSL mode is set to "require" for central node database connections

## Deployment Process

1. Deploy central node (s-04) first with `endoreg-db-central-01` role
2. Deploy local nodes with updated `endoreg-client` role including `centralNodes` configuration
3. Local nodes will automatically know how to communicate with the central node

## Monitoring and Logs

Both central and local nodes log to systemd journal:
```bash
# Central node
journalctl -u endo-api-boot.service -f

# Local nodes  
journalctl -u endo-api-boot.service -f
```

## For EndoReg API Repository Maintainers

This section provides important information for developers and maintainers working on the endo-api repository.

### Auto-Generated Configuration Files

The NixOS deployment system automatically generates and manages several configuration files:

#### `local_settings.py`
- **Location**: Symlinked into the repository root as `${repoDir}/local_settings.py`
- **Source**: Generated from Nix configuration and stored in `/var/endoreg-service-user/config/local_settings.py`
- **Purpose**: Contains Django settings specific to the deployment environment
- **Content**: Database credentials, security settings, logging configuration, and node topology

**Important**: Do NOT commit `local_settings.py` to the repository. It's environment-specific and contains sensitive information.

#### Generated Settings Include:
```python
# Database configuration (automatically configured)
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'endoregDbLocal',  # or 'endoregDbCentral' for central nodes
        'USER': 'endoregDbLocal',  # or 'endoregDbCentral' for central nodes
        'PASSWORD': '<auto-loaded from vault>',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}

# Security (auto-generated)
SECRET_KEY = '<auto-generated-key>'
DEBUG = False  # True only in development
ALLOWED_HOSTS = ['localhost', '127.0.0.1']  # extended for central nodes

# Node topology (automatically set)
CENTRAL_NODES = ["s-04"]
IS_CENTRAL_NODE = False  # True only for central nodes
LOCAL_NODES = ["gs-01", "gs-02", "gc-05", "gc-06", "gc-10"]  # for central nodes

# CORS settings (if configured)
CORS_ALLOWED_ORIGINS = [...]
CORS_ALLOW_CREDENTIALS = True

# Logging and other settings...
```

### Repository Structure Expectations

The deployment system expects the following structure in the endo-api repository:

```
endo-api/
├── conf/
│   └── db_pwd              # Auto-populated with database password
├── local_settings.py       # Auto-generated symlink (DO NOT COMMIT)
├── devenv.nix              # Development environment
├── .envrc                  # direnv configuration
└── <your Django project>
```

### Development vs Production Settings

#### Development
- `DEBUG = True` (when explicitly configured)
- Detailed logging
- Development server mode
- Local-only access

#### Production (Default)
- `DEBUG = False`
- Secure logging configuration
- Production server mode via `devenv shell -- run-prod-server`
- Network access based on node type

### Integration Points

Your Django application should be designed to:

1. **Import local settings**:
   ```python
   # In your main settings.py
   try:
       from .local_settings import *
   except ImportError:
       pass
   ```

2. **Use the provided database configuration**: The `DATABASES` setting is fully configured

3. **Respect node topology**: Use `IS_CENTRAL_NODE` and `CENTRAL_NODES` to adjust behavior

4. **Handle CORS appropriately**: CORS settings are pre-configured based on deployment

### Secret Management

- Database passwords are managed via NixOS vault system
- Django secret keys are auto-generated per deployment
- SSL certificates (if used) are managed through NixOS configuration
- **Never hardcode secrets in the repository**

### Deployment Lifecycle

1. **Repository Clone/Update**: Handled automatically by systemd service
2. **Branch Checkout**: Defaults to `environment-setup` branch
3. **Submodule Updates**: Automatically initialized and updated
4. **Configuration Generation**: `local_settings.py` is created/updated
5. **Service Start**: `devenv shell -- run-prod-server` is executed

### Environment Variables Available

The service runs with these additional environment variables (for central nodes):
```bash
DJANGO_SETTINGS_MODULE=endoreg_api.settings.central
CENTRAL_NODE=true
# Plus any custom variables configured in NixOS
```

### Debugging Deployment Issues

1. **Check service logs**: `journalctl -u endo-api-boot.service -f`
2. **Verify configuration**: Check `/var/endoreg-service-user/config/local_settings.py`
3. **Database connectivity**: Ensure PostgreSQL service is running
4. **Permissions**: Repository should be owned by `endoreg-service-user`
5. **Dependencies**: Ensure `devenv` environment is properly configured

### Testing Locally

To test your changes before deployment:

1. Clone the repository locally
2. Create a minimal `local_settings.py` based on the generated template
3. Use `devenv shell` to enter the development environment
4. Run tests and development server as usual

### Configuration Override

If you need to override any auto-generated settings:

1. **For deployment-wide changes**: Modify the NixOS role configuration
2. **For application-specific changes**: Use Django's settings system properly
3. **For temporary debugging**: Environment variables can be set in NixOS service configuration

### Best Practices

1. **Git Ignore**: Ensure `local_settings.py` is in `.gitignore`
2. **Environment Detection**: Use `IS_CENTRAL_NODE` to adapt application behavior
3. **Database Migrations**: Handle them in your application startup logic
4. **Static Files**: Configure static file serving appropriately for production
5. **Logging**: Use Django's logging system; configuration is pre-set
6. **Security**: Rely on the provided security settings rather than rolling your own

### Support and Troubleshooting

For deployment-related issues:
- Check NixOS configuration in `/home/admin/dev/luxnix/modules/nixos/`
- Review Ansible inventory in `/home/admin/dev/luxnix/ansible/inventory/`
- Consult this documentation and the troubleshooting section above

## Troubleshooting

### Common Issues

1. **Central node not accessible**: Check firewall, nginx configuration, and ALLOWED_HOSTS
2. **Local nodes can't connect**: Verify central node is running and accessible on port 8118
3. **Database connection issues**: Check password files and PostgreSQL service status
4. **Configuration issues**: Verify ansible inventory groups and role assignments

### Permission Errors

If you see "Permission denied" errors when copying `local_settings.py`:
```bash
# Check service user permissions
sudo ls -la /var/endoreg-service-user/
sudo ls -la /var/endoreg-service-user/endo-api/

# Verify tmpfiles were created
sudo systemd-tmpfiles --create

# Check service logs
journalctl -u endo-api-boot.service -f
```

### Configuration File Issues

1. **Missing local_settings.py**: 
   - Check that the symlink was created: `ls -la /var/endoreg-service-user/endo-api/local_settings.py`
   - Verify source file exists: `ls -la /var/endoreg-service-user/config/local_settings.py`

2. **Invalid Django settings**:
   - Review generated settings: `sudo cat /var/endoreg-service-user/config/local_settings.py`
   - Check for syntax errors in the generated Python code

3. **Database connection failures**:
   - Verify password file: `sudo ls -la /etc/secrets/vault/SCRT_local_password_maintenance_password`
   - Test PostgreSQL connectivity: `sudo -u postgres psql -c "\l"`

### Repository Issues

1. **Git repository problems**:
   - Check repository ownership: `sudo ls -la /var/endoreg-service-user/`
   - Verify git operations: `sudo -u endoreg-service-user git -C /var/endoreg-service-user/endo-api status`

2. **Branch checkout failures**:
   - Ensure the specified branch exists in the remote repository
   - Check network connectivity to GitHub

3. **Submodule issues**:
   - Verify submodules are properly initialized
   - Check for authentication issues with submodule repositories

### Service Startup Issues

1. **devenv not found**:
   - Verify devenv is installed and in PATH
   - Check service environment variables

2. **Django startup errors**:
   - Review Django application logs
   - Ensure all required dependencies are available in the devenv environment

3. **Port binding issues**:
   - Check if port 8118 is already in use: `sudo netstat -tlnp | grep 8118`
   - Verify firewall configuration

### Recovery Procedures

If the service is completely broken:

1. **Stop the service**: `sudo systemctl stop endo-api-boot.service`
2. **Clear the repository**: `sudo rm -rf /var/endoreg-service-user/endo-api`
3. **Clear config files**: `sudo rm -rf /var/endoreg-service-user/config`
4. **Recreate directories**: `sudo systemd-tmpfiles --create`
5. **Restart the service**: `sudo systemctl start endo-api-boot.service`

### Getting Help

For complex issues:
1. Collect service logs: `journalctl -u endo-api-boot.service --no-pager > service.log`
2. Check system logs: `journalctl --since "1 hour ago" | grep endoreg > system.log`
3. Review configuration files and include relevant sections in your bug report
